# 문제
아래 두 테이블이 있습니다.
- order(order_id, customer_id, channel_id, order_dt, order_amt, status)
- customer(customer_id, gender, age, region)

[문제]
최근 30일간 정상 주문(status='정상') 기준,
1회 이상 주문한 모든 고객에 대해
- 고객 ID,
- 전체 주문수(order_cnt),
- 총 주문액(total_amt),
- 주문간 평균 구매간격(일) (avg_gap_days)을 구하세요.

평균 구매간격:
- 고객별로 주문일을 오름차순 정렬
- 각 주문의 날짜 차이(일) 평균
(즉, [두 번째 주문일 - 첫 주문일], [세 번째 주문일 - 두 번째 주문일], … 등등의 평균)
- 주문이 1건뿐인 고객은 avg_gap_days는 NULL로 표시

출력 컬럼:
- customer_id
- order_cnt
- total_amt
- avg_gap_days

오라클 기준, order_cnt 내림차순, 그 안에서 customer_id 오름차순 정렬

# 내 풀이
```
SELECT
  customer_id,
  COUNT(*) AS order_cnt,
  SUM(order_amt) AS total_amt,
  CASE
    WHEN COUNT(*) = 1 THEN NULL
    ELSE ROUND(AVG(gap_days))
  END AS avg_gap_days
FROM (
  SELECT
    o.customer_id,
    o.order_amt,
    trunc(o.order_dt) AS order_dt,
    trunc(o.order_dt) - LAG(trunc(o.order_dt)) OVER (PARTITION BY o.customer_id ORDER BY trunc(o.order_dt)) AS gap_days
  FROM
    order o
  WHERE
    o.status = '정상'
    AND trunc(o.order_dt) >= trunc(sysdate) - 29
)
GROUP BY customer_id
ORDER BY order_cnt DESC, customer_id
;
```